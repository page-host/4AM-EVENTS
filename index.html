<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <!-- Primary Meta Tags -->
    <title>4AM Events - Interactive Academic & Community Calendar Planner</title>
    <meta name="title" content="4AM Events - Interactive Academic & Community Calendar Planner">
    <meta name="description" content="Stay organized with 4AM Events. A high-performance, responsive academic calendar for tracking exams, assignments, classes, and community events in real-time.">
    <meta name="keywords" content="academic planner, event calendar, study schedule, exam tracker, 4am events, student organization tool, digital calendar">
    <meta name="author" content="4AM Team">
    <meta name="robots" content="index, follow">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://4am-events.vercel.app/"> 
    <meta property="og:title" content="4AM Events - Interactive Academic & Community Calendar Planner">
    <meta property="og:description" content="Manage your academic life seamlessly. Track every assignment and exam with our intuitive calendar interface.">
    <meta property="og:image" content="assets/cal.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="4AM Events - Interactive Academic & Community Calendar Planner">
    <meta property="twitter:description" content="Manage your academic life seamlessly. Track every assignment and exam with our intuitive calendar interface.">
    <meta property="twitter:image" content="assets/cal.png">

    <!-- JSON-LD Structured Data for Google -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "4AM Events",
      "operatingSystem": "Web",
      "applicationCategory": "EducationApplication",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "description": "A responsive event calendar application tracking academic and community events for students.",
      "featureList": "Event tracking, Academic scheduling, Mobile responsive, Dark mode support, Real-time updates"
    }
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
     <!--  Logo -->
    <link rel="icon" href="assets/cal.png">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Poppins', 'sans-serif'],
            },
            colors: {
              brand: {
                pink: '#FF136F',
                orange: '#FF9C35',
                purple: '#3F07F8',
                light: '#FEEAE9',
              }
            }
          }
        }
      }
    </script>
    <style>
      body {
        transition: background-color 0.3s ease;
        min-height: 100vh;
        overflow-x: hidden;
      }
      body:not(.dark) {
        background: #F3E8FF; 
        background: linear-gradient(135deg, #EEF2FF 0%, #F3E8FF 50%, #FFF1F2 100%);
      }
      body.dark {
        background: #111827;
        background: linear-gradient(135deg, #0f172a 0%, #111827 50%, #111827 100%);
      }
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      .custom-scrollbar::-webkit-scrollbar { width: 4px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background-color: rgba(156, 163, 175, 0.5); border-radius: 20px; }
      
      /* Mobile tap highlight fix */
      * { -webkit-tap-highlight-color: transparent; }
      
      /* Smooth transitions for grid cells */
      .cell-transition { transition: transform 0.1s ease-in-out, background-color 0.1s; }

      /* Custom Today Gradient */
      .bg-gradient-today {
        background: linear-gradient(135deg, #ff00cc, #333399);
      }

      /* Gradient Text Utility */
      .text-gradient-brand {
        background: linear-gradient(to bottom right, #FF136F, #3F07F8, #FF9C35);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      
      /* Essential for perfectly equal date boxes */
      .calendar-grid-cell {
        aspect-ratio: 1 / 1;
        min-height: 0;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      
      .modal-anim {
        animation: modalScale 0.2s cubic-bezier(0.16, 1, 0.3, 1);
      }
      @keyframes modalScale {
        from { transform: scale(0.95); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
      }

      .course-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .course-card:hover {
        transform: translateY(-4px);
      }

      .preview-anim {
        animation: previewZoom 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      }
      @keyframes previewZoom {
        from { transform: scale(0.8); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
      }
      
      .nav-btn {
        transition: all 0.2s ease;
      }
      .nav-btn:active {
        transform: scale(0.9);
      }

      /* --- 2026 ANIMATION CSS --- */
      .glass-panel {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 15px 50px 0 rgba(0, 0, 0, 0.5);
      }
      @keyframes float-2026 {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
      }
      @keyframes glow-2026 {
        0% { width: 40%; left: 30%; opacity: 0.5; }
        100% { width: 100%; left: 0; opacity: 1; }
      }
      .animate-float { animation: float-2026 6s ease-in-out infinite; }
    </style>
  </head>
  <body class="antialiased font-sans">
    
    <!-- 2026 NEW YEAR OVERLAY -->
    <div id="ny-2026-overlay" class="fixed inset-0 z-[9999] bg-[#05030a] overflow-hidden">
        <canvas id="canvas-container" class="fixed inset-0 w-full h-full"></canvas>
        
        <div class="relative z-10 flex flex-col items-center justify-center h-full text-center px-4 pointer-events-none">
            
            <div class="glass-panel p-6 md:p-12 rounded-3xl animate-float pointer-events-auto max-w-2xl w-full">
                <div class="text-[#00f260] font-bold text-lg md:text-2xl tracking-[0.3em] uppercase mb-4 drop-shadow-[0_0_15px_rgba(0,242,96,0.6)]">Happy New Year</div>
                
                <h1 class="text-6xl md:text-9xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white via-[#ffd700] to-[#ff8c00] mb-8 relative leading-none filter drop-shadow-[0_0_20px_rgba(255,215,0,0.5)]">
                    2026
                    <div class="absolute bottom-0 left-0 w-full h-1 md:h-2 bg-[#ffd700] shadow-[0_0_15px_#ffd700] animate-[glow-2026_2s_infinite_alternate]"></div>
                </h1>
                
                <div id="countdown" class="flex justify-center gap-2 md:gap-6 flex-wrap mb-8">
                    <div class="flex flex-col items-center min-w-[60px] md:min-w-[80px]">
                        <span class="text-2xl md:text-5xl font-black bg-black/40 text-white border border-white/10 rounded-lg p-2 md:p-3 font-mono" id="ny-days">00</span>
                        <span class="text-[10px] md:text-sm font-bold text-white/70 mt-2 uppercase">Days</span>
                    </div>
                    <div class="flex flex-col items-center min-w-[60px] md:min-w-[80px]">
                        <span class="text-2xl md:text-5xl font-black bg-black/40 text-white border border-white/10 rounded-lg p-2 md:p-3 font-mono" id="ny-hours">00</span>
                        <span class="text-[10px] md:text-sm font-bold text-white/70 mt-2 uppercase">Hours</span>
                    </div>
                    <div class="flex flex-col items-center min-w-[60px] md:min-w-[80px]">
                        <span class="text-2xl md:text-5xl font-black bg-black/40 text-white border border-white/10 rounded-lg p-2 md:p-3 font-mono" id="ny-minutes">00</span>
                        <span class="text-[10px] md:text-sm font-bold text-white/70 mt-2 uppercase">Minutes</span>
                    </div>
                    <div class="flex flex-col items-center min-w-[60px] md:min-w-[80px]">
                        <span class="text-2xl md:text-5xl font-black bg-black/40 text-white border border-white/10 rounded-lg p-2 md:p-3 font-mono" id="ny-seconds">00</span>
                        <span class="text-[10px] md:text-sm font-bold text-white/70 mt-2 uppercase">Seconds</span>
                    </div>
                </div>

                <p class="text-xs md:text-sm text-white/50 animate-pulse font-bold tracking-widest uppercase" id="ny-sound-hint">Sound Attempting to Start...</p>
            </div>
        </div>

        <button onclick="close2026Overlay()" class="fixed top-6 right-6 z-20 bg-white/10 hover:bg-white/20 text-white backdrop-blur-md border border-white/30 rounded-full p-3 md:p-4 transition-all hover:scale-110 shadow-lg group">
            <i data-lucide="x" class="w-6 h-6 md:w-8 md:h-8"></i>
            <span class="absolute right-full mr-3 top-1/2 -translate-y-1/2 bg-black/80 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none">Close to Enter Calendar</span>
        </button>
    </div>

    <header class="sr-only">
      <h1>4AM Events Academic Planner</h1>
      <p>Organize your university life, track assignments, and never miss a class with our digital schedule.</p>
    </header>

    <main id="root" class="min-h-screen p-2 md:p-8 max-w-7xl mx-auto selection:bg-brand-pink selection:text-white opacity-0 transition-opacity duration-1000">
      <!-- Loading State -->
      <div class="flex flex-col items-center justify-center min-h-[50vh] text-brand-purple">
        <i data-lucide="loader-2" class="w-10 h-10 animate-spin mb-4"></i>
        <p class="animate-pulse font-medium text-lg">Loading your schedule...</p>
      </div>
    </main>

    <footer class="sr-only">
      <p>&copy; 2025 4AM Events. Built for academic excellence.</p>
    </footer>

    <!-- Application Logic -->
    <script>
      // --- CALENDAR CONFIGURATION ---
      const REPO_OWNER = "page-host";
      const REPO_NAME = "4AM-EVENTS";
      const FILE_PATH = "events.json";
      const COURSES_FOLDER = "4";
      
      const APP_URL = window.location.href.split('?')[0].split('#')[0].replace(/\/$/, "");

      // --- CALENDAR DEFAULT DATA ---
      const DEFAULT_EVENTS = {
        "2025-12-02": [{ "title": "à¦à¦•à¦¾à¦‰à¦¨à§à¦Ÿà¦¿à¦‚ à¦¸à¦¿à¦Ÿà¦¿", "description": "à¦¸à¦¿à¦Ÿà¦¿ à¦Ÿà¦ªà¦¿à¦• : Worksheet, Cost of goods statement" }],
        "2025-12-01": [{ "title": "à¦¬à¦¾à¦‚à¦²à¦¾ à¦à¦¸à¦¾à¦‡à¦¨à¦®à§‡à¦¨à§à¦Ÿ à¦¸à¦¾à¦¬à¦®à¦¿à¦Ÿ", "description": "à¦à¦¸à¦¾à¦‡à¦¨à¦®à§‡à¦¨à§à¦Ÿ à¦Ÿà¦ªà¦¿à¦• : à¦¤à§‹à¦®à¦¾à¦° à¦œà§€à¦¬à¦¨à§‡à¦° à¦•à§à¦·à§à¦¦à§‡ à¦—à¦²à§à¦ª" }],
        "2025-12-03": [{ "title": "à¦•à¦®à§à¦ªà¦¿à¦‰à¦Ÿà¦¾à¦° à¦…à§à¦¯à¦¾à¦²à¦—à¦°à¦¿à¦¦à¦® à¦¸à¦¿à¦Ÿà¦¿", "description": "à¦¸à¦¿à¦Ÿà¦¿ à¦Ÿà¦ªà¦¿à¦• : à¦—à§à¦°à¦¿à¦¡à¦¿ à¦…à§à¦¯à¦¾à¦²à¦—à¦°à¦¿à¦¦à¦®" }],
        "2025-12-04": [{ "title": "à¦¡à¦¿à¦¬à¦¿à¦à¦®à¦à¦¸ à¦®à§‡à¦•à¦†à¦ª à¦•à§à¦²à¦¾à¦¸", "description": "Class Link : https://bdren.zoom.us/j/92389227210?pwd=UVl27Y8qrD4TWDfrSTDYZC3yQOsnCV.1" }],
        "2025-12-05": [{ "title": "à¦¬à¦¾à¦‚à¦²à¦¾ à¦…à¦¨à¦²à¦¾à¦‡à¦¨ à¦•à§à¦²à¦¾à¦¸", "description": "à¦†à¦—à¦¾à¦®à§€à¦•à¦¾à¦² à¦°à¦¾à¦¤ à§§à§¦à¦Ÿà¦¾à¦¯à¦¼ à¦¬à¦¾à¦‚à¦²à¦¾ à¦…à¦¨à¦²à¦¾à¦‡à¦¨ à¦•à§à¦²à¦¾à¦¸ à¦¹à¦¬à§‡..Postponed" }],
        "2025-12-15": [{ "title": "à¦¡à¦¿à¦¬à¦¿à¦à¦®à¦à¦¸ à¦²à§à¦¯à¦¾à¦¬ à¦¸à¦¿à¦Ÿà¦¿ postponed", "description": "à¦Ÿà¦ªà¦¿à¦• : à¦à¦‡à¦šà¦†à¦° à¦¸à§à¦•à¦¿à¦®à¦¾" }],
        "2025-12-11": [
          { "title": "à¦¡à¦¿à¦¬à¦¿à¦à¦®à¦à¦¸ à¦®à§‡à¦•à¦†à¦ª à¦•à§à¦²à¦¾à¦¸", "description": "Class link : https://bdren.zoom.us/j/92038918111?pwd=3ayeQb8G76zFmlx8USUlWbGcDOahoP.1" },
          { "title": "à¦¡à¦¿à¦¬à¦¿à¦à¦®à¦à¦¸ à¦²à§à¦¯à¦¾à¦¬ à¦ªà§à¦°à¦œà§‡à¦•à§à¦Ÿ à¦°à¦¿à¦ªà§‹à¦°à§à¦Ÿ", "description": "Project assigned in Classroom" }
        ],
        "2025-12-20": [{ "title": "à¦à¦²à¦—à¦°à¦¿à¦¦à¦® à¦²à§à¦¯à¦¾à¦¬ à¦°à¦¿à¦ªà§‹à¦°à§à¦Ÿ à¦¸à¦¾à¦¬à¦®à¦¿à¦¶à¦¨ & à¦•à§à¦‡à¦œ extended", "description": "à¦²à§à¦¯à¦¾à¦¬ à¦°à¦¿à¦ªà§‹à¦°à§à¦Ÿ à¦Ÿà¦ªà¦¿à¦• : Activity Selection, Huffman coding, BFS, DFS, Dijkstra. à¦•à§à¦‡à¦œ à¦Ÿà¦ªà¦¿à¦• : à¦«à¦¾à¦‡à¦¨à¦¾à¦² à¦ à¦¯à¦¾ à¦†à¦›à§‡ à¦¸à¦¬à¥¤" }],
        "2025-12-23": [{ "title": "Toc à¦¸à¦¿à¦Ÿà¦¿ extended", "description": "à¦Ÿà¦ªà¦¿à¦• : Cnf, equivalence with cfg" }],
        "2025-12-24": [{ "title": "à¦à¦²à¦—à¦°à¦¿à¦¦à¦® à¦²à§à¦¯à¦¾à¦¬ à¦à¦•à§à¦¸à¦¾à¦®", "description": "à¦Ÿà¦ªà¦¿à¦• : All algorithms covered in class." }]
      };

      // --- CALENDAR STATE ---
      const state = {
        currentDate: new Date(2025, 11, 1),
        selectedDateKey: null,
        events: DEFAULT_EVENTS,
        adminToken: localStorage.getItem('4am_admin_token'),
        isSaving: false,
        isAdminModalOpen: false,
        isAddEventMode: false,
        editingEventIndex: null,
        formTitle: '',
        formDesc: '',
        isDarkMode: localStorage.getItem('4am_dark_mode') === 'true',
        
        courses: [],
        isLoadingCourses: false,
        selectedCourse: null,
        courseImages: [],
        isLoadingGallery: false,
        previewImageIndex: null,

        isReminderModalOpen: false, 
        reminderValue: parseInt(localStorage.getItem('4am_reminder_value')) || 1,
        reminderUnit: localStorage.getItem('4am_reminder_unit') || 'days',
        notificationsEnabled: localStorage.getItem('4am_notifications_enabled') === 'true',
        notificationPermission: 'default'
      };

      if (state.isDarkMode) {
        document.body.classList.add('dark');
        document.documentElement.classList.add('dark');
      }

      if ('Notification' in window) {
        state.notificationPermission = Notification.permission;
      }

      // --- CALENDAR FUNCTIONS ---

      async function requestNotificationPermission() {
        if (!('Notification' in window)) return false;
        if (Notification.permission === 'granted') return true;
        if (Notification.permission !== 'denied') {
          const permission = await Notification.requestPermission();
          state.notificationPermission = permission;
          return permission === 'granted';
        }
        return false;
      }

      function scheduleNotifications() {
        if (!state.notificationsEnabled) return;
        if (window.notificationInterval) clearInterval(window.notificationInterval);
        window.notificationInterval = setInterval(checkUpcomingEvents, 3600000);
        checkUpcomingEvents();
      }

      function checkUpcomingEvents() {
        if (!state.notificationsEnabled || state.notificationPermission !== 'granted') return;
        const now = new Date();
        const multiplier = state.reminderUnit === 'hours' ? 3600000 : 86400000;
        const reminderMs = state.reminderValue * multiplier;
        Object.keys(state.events).forEach(dateKey => {
          const eventDate = new Date(dateKey);
          eventDate.setHours(9, 0, 0, 0);
          const timeDiff = eventDate - now;
          if (timeDiff > 0 && timeDiff <= reminderMs) {
            const events = state.events[dateKey];
            const notifiedKey = `notified_${dateKey}`;
            if (!sessionStorage.getItem(notifiedKey)) {
              events.forEach(evt => showNotification(evt, dateKey));
              sessionStorage.setItem(notifiedKey, 'true');
            }
          }
        });
      }

      function showNotification(event, dateKey) {
        if (state.notificationPermission !== 'granted') return;
        const dateStr = new Date(dateKey).toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
        const notification = new Notification('ðŸ“… Upcoming: ' + event.title, {
          body: `${dateStr}\n${event.description || 'No details'}`,
          icon: 'assets/cal.png',
          badge: 'assets/cal.png',
          tag: dateKey + event.title,
          requireInteraction: false,
          vibrate: [200, 100, 200]
        });
        notification.onclick = function() {
          window.focus();
          actions.navigateToDate(dateKey);
          notification.close();
        };
      }

      function testNotification() {
        if (state.notificationPermission !== 'granted') return;
        const notification = new Notification('ðŸ”” 4AM Events Test', {
          body: 'Notifications are working! You\'ll be alerted about upcoming events.',
          icon: 'assets/cal.png',
          tag: 'test-notification'
        });
        setTimeout(() => notification.close(), 5000);
      }

      const formatDateKey = (year, month, day) => `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
      const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();
      const getMonthName = (monthIndex) => new Date(0, monthIndex).toLocaleString('default', { month: 'long' });

      async function fetchEvents() {
        try {
          const res = await fetch(`${FILE_PATH}?t=${Date.now()}`);
          if (res.ok) state.events = await res.json();
        } catch (e) { console.warn("Using default events"); } finally {
          renderCalendarUI();
          fetchCourses();
          const urlParams = new URLSearchParams(window.location.search);
          if (urlParams.has('openDate')) actions.navigateToDate(urlParams.get('openDate'));
        }
      }

      async function fetchCourses() {
        state.isLoadingCourses = true;
        renderCalendarUI();
        try {
          const apiUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${COURSES_FOLDER}`;
          const res = await fetch(apiUrl);
          if (res.ok) {
            const data = await res.json();
            state.courses = data.filter(item => item.type === 'dir').map(item => item.name).sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }));
          }
        } catch (e) { console.error("Error fetching courses:", e); } finally {
          state.isLoadingCourses = false;
          renderCalendarUI();
        }
      }

      async function fetchCourseImages(courseName) {
        state.selectedCourse = courseName;
        state.isLoadingGallery = true;
        state.courseImages = [];
        renderCalendarUI();
        try {
          const apiUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${COURSES_FOLDER}/${encodeURIComponent(courseName)}`;
          const res = await fetch(apiUrl);
          if (res.ok) {
            const data = await res.json();
            const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'];
            const sortedItems = data.filter(item => item.type === 'file' && imageExtensions.includes(item.name.split('.').pop().toLowerCase())).sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }));
            state.courseImages = sortedItems.map(item => item.download_url);
          }
        } catch (e) { console.error("Error fetching course images:", e); } finally {
          state.isLoadingGallery = false;
          renderCalendarUI();
        }
      }

      async function saveEventsToGitHub() {
        if (!state.adminToken) return;
        state.isSaving = true;
        renderCalendarUI();
        try {
          const apiUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`;
          const getRes = await fetch(apiUrl, { headers: { Authorization: `token ${state.adminToken}`, Accept: 'application/vnd.github.v3+json' } });
          let sha = null;
          if (getRes.ok) sha = (await getRes.json()).sha;
          const content = btoa(unescape(encodeURIComponent(JSON.stringify(state.events, null, 2))));
          const putRes = await fetch(apiUrl, {
            method: 'PUT',
            headers: { Authorization: `token ${state.adminToken}`, Accept: 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: 'Update events via Admin UI', content, sha })
          });
          if (!putRes.ok) throw new Error('Failed to save');
        } catch (e) { alert(`Error saving: ${e.message}`); } finally {
          state.isSaving = false;
          renderCalendarUI();
        }
      }

      async function verifyAdminToken(token) {
        try {
          const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}`, { headers: { Authorization: `token ${token}`, Accept: 'application/vnd.github.v3+json' } });
          return res.ok;
        } catch (e) { return false; }
      }

      const actions = {
        toggleDarkMode: () => {
          state.isDarkMode = !state.isDarkMode;
          localStorage.setItem('4am_dark_mode', state.isDarkMode);
          document.body.classList.toggle('dark');
          document.documentElement.classList.toggle('dark');
          renderCalendarUI();
        },
        prevMonth: () => { state.currentDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth() - 1, 1); renderCalendarUI(); },
        nextMonth: () => { state.currentDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth() + 1, 1); renderCalendarUI(); },
        today: () => { state.currentDate = new Date(); renderCalendarUI(); },
        navigateToDate: (dateKey) => {
          const d = new Date(dateKey);
          if (isNaN(d.getTime())) return;
          state.currentDate = new Date(d.getFullYear(), d.getMonth(), 1);
          state.selectedDateKey = dateKey;
          renderCalendarUI();
        },
        selectDate: (dateKey) => { 
          state.selectedDateKey = dateKey; state.isAddEventMode = false; state.editingEventIndex = null; 
          try { const newUrl = APP_URL + "?openDate=" + dateKey; window.history.pushState({ dateKey }, '', newUrl); } catch (e) {}
          renderCalendarUI(); 
        },
        closeModal: () => { 
          state.selectedDateKey = null; try { const cleanUrl = APP_URL; window.history.pushState({}, '', cleanUrl); } catch (e) {}
          renderCalendarUI(); 
        },
        openAdminModal: () => { state.isAdminModalOpen = true; renderCalendarUI(); },
        closeAdminModal: () => { state.isAdminModalOpen = false; renderCalendarUI(); },
        login: async (token) => {
          if (await verifyAdminToken(token)) {
            state.adminToken = token; localStorage.setItem('4am_admin_token', token); state.isAdminModalOpen = false; renderCalendarUI();
          } else { alert("Invalid Token"); }
        },
        logout: () => { state.adminToken = null; localStorage.removeItem('4am_admin_token'); renderCalendarUI(); },
        startAddEvent: () => { state.isAddEventMode = true; state.formTitle = ''; state.formDesc = ''; renderCalendarUI(); },
        startEditEvent: (idx) => {
          const evt = state.events[state.selectedDateKey][idx];
          state.editingEventIndex = idx; state.formTitle = evt.title; state.formDesc = evt.description; renderCalendarUI();
        },
        cancelForm: () => { state.isAddEventMode = false; state.editingEventIndex = null; renderCalendarUI(); },
        saveForm: () => {
          const newEvent = { title: state.formTitle, description: state.formDesc };
          const list = state.events[state.selectedDateKey] || [];
          if (state.editingEventIndex !== null) list[state.editingEventIndex] = newEvent; else list.push(newEvent);
          state.events[state.selectedDateKey] = list;
          state.isAddEventMode = false; state.editingEventIndex = null; saveEventsToGitHub(); renderCalendarUI();
        },
        deleteEvent: (idx) => {
          if (!confirm('Delete this event?')) return;
          const list = state.events[state.selectedDateKey]; list.splice(idx, 1);
          if (list.length === 0) delete state.events[state.selectedDateKey]; saveEventsToGitHub(); renderCalendarUI();
        },
        updateForm: (field, val) => { if (field === 'title') state.formTitle = val; if (field === 'desc') state.formDesc = val; },
        shareEvent: (dateKey) => {
          const shareUrl = `${APP_URL}?openDate=${dateKey}`;
          navigator.clipboard.writeText(shareUrl).then(() => {
            const btn = document.getElementById('share-btn-text');
            if (btn) { const original = btn.innerText; btn.innerText = "Link Copied!"; setTimeout(() => { if (btn) btn.innerText = original; }, 2000); }
          }).catch(err => alert("Share Link: " + shareUrl));
        },
        setReminderValue: (val) => { state.reminderValue = val; },
        setReminderUnit: (val) => { state.reminderUnit = val; },
        openReminderModal: () => { state.isReminderModalOpen = true; renderCalendarUI(); },
        closeReminderModal: () => { state.isReminderModalOpen = false; renderCalendarUI(); },
        confirmReminder: async () => {
          const granted = await requestNotificationPermission();
          if (granted) {
            state.notificationsEnabled = true; state.notificationPermission = 'granted';
            localStorage.setItem('4am_notifications_enabled', 'true');
            localStorage.setItem('4am_reminder_value', state.reminderValue);
            localStorage.setItem('4am_reminder_unit', state.reminderUnit);
            scheduleNotifications(); testNotification(); state.isReminderModalOpen = false;
          } else { alert('Please enable notifications in your browser settings to receive alerts.'); }
          renderCalendarUI();
        },
        disableReminders: () => {
          state.notificationsEnabled = false; localStorage.setItem('4am_notifications_enabled', 'false');
          if (window.notificationInterval) clearInterval(window.notificationInterval); state.isReminderModalOpen = false; renderCalendarUI();
        },
        closeGallery: () => { state.selectedCourse = null; state.courseImages = []; renderCalendarUI(); },
        openPreview: (index) => { state.previewImageIndex = index; renderCalendarUI(); },
        closePreview: () => { state.previewImageIndex = null; renderCalendarUI(); },
        nextPreviewImage: (e) => { if (e) e.stopPropagation(); if (state.courseImages.length === 0) return; state.previewImageIndex = (state.previewImageIndex + 1) % state.courseImages.length; renderCalendarUI(); },
        prevPreviewImage: (e) => { if (e) e.stopPropagation(); if (state.courseImages.length === 0) return; state.previewImageIndex = (state.previewImageIndex - 1 + state.courseImages.length) % state.courseImages.length; renderCalendarUI(); }
      };

      window.addEventListener('keydown', (e) => {
        if (state.previewImageIndex !== null) {
          if (e.key === 'ArrowRight') actions.nextPreviewImage();
          if (e.key === 'ArrowLeft') actions.prevPreviewImage();
          if (e.key === 'Escape') actions.closePreview();
        }
      });

      function Icon(name, size=20, extraClass='') { return `<i data-lucide="${name}" width="${size}" height="${size}" class="${extraClass}"></i>`; }

      function renderCalendarUI() {
        const root = document.getElementById('root');
        if(!root) return; // Guard clause if overlay is closed and root is removed/recreated

        // Re-render logic (simplified for brevity in combined code)
        // ... (Keeping the original render functions structure) ...
        
        // Header
        const year = state.currentDate.getFullYear();
        const monthName = getMonthName(state.currentDate.getMonth());
        
        const headerHtml = `
          <div class="flex flex-col md:flex-row justify-between items-center mb-6 bg-white dark:bg-gray-800 p-4 rounded-3xl shadow-lg border border-white dark:border-gray-700 gap-4 w-full">
            <div class="flex items-center gap-3 w-full md:w-auto">
              <div class="w-12 h-12 shrink-0 bg-gradient-to-br from-brand-pink to-brand-orange rounded-2xl flex items-center justify-center shadow-lg text-white">
                ${Icon('calendar', 24)}
              </div>
              <div class="flex-1">
                <h1 class="text-xl md:text-2xl font-extrabold text-gray-900 dark:text-gray-100 tracking-tight leading-tight">4AM Events</h1>
                <p class="text-[10px] text-brand-purple dark:text-brand-pink font-bold tracking-[0.2em] uppercase">Academic Planner</p>
              </div>
            </div>
            <div class="flex flex-col sm:flex-row items-center gap-3 w-full md:w-auto">
              <div class="flex items-center bg-gray-50 dark:bg-gray-700/50 p-1 rounded-xl w-full sm:w-auto justify-between border border-gray-100 dark:border-gray-600 order-2 sm:order-1">
                <button onclick="actions.prevMonth()" class="p-2 hover:bg-white dark:hover:bg-gray-700 hover:shadow rounded-lg text-gray-800 dark:text-gray-400 active:scale-95 transition-transform">${Icon('chevron-left', 20)}</button>
                <div class="px-4 flex-1 text-center font-bold text-gray-800 dark:text-gray-200 text-sm sm:text-base whitespace-nowrap min-w-[120px]">${monthName} <span class="text-brand-purple dark:text-brand-orange">${year}</span></div>
                <button onclick="actions.nextMonth()" class="p-2 hover:bg-white dark:hover:bg-gray-700 hover:shadow rounded-lg text-gray-600 dark:text-gray-400 active:scale-95 transition-transform">${Icon('chevron-right', 20)}</button>
              </div>
              <div class="flex gap-2 w-full sm:w-auto justify-end order-1 sm:order-2">
                <button onclick="actions.toggleDarkMode()" class="px-3 py-2 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-600 shadow-sm active:scale-95 transition-transform">${Icon(state.isDarkMode ? 'sun' : 'moon', 20)}</button>
                <button onclick="actions.openReminderModal()" class="px-3 py-2 ${state.notificationsEnabled ? 'bg-green-50 dark:bg-green-900/30 border-green-200 dark:border-green-700 text-green-600 dark:text-green-400' : 'bg-white dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-400'} border rounded-xl hover:bg-gray-50 dark:hover:bg-gray-600 shadow-sm active:scale-95 transition-all relative">${Icon(state.notificationsEnabled ? 'bell-ring' : 'bell-off', 20)}${state.notificationsEnabled ? '<span class="absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>' : ''}</button>
                <button onclick="actions.today()" class="px-4 py-2 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-800 dark:text-gray-200 text-sm font-bold rounded-xl hover:bg-gray-50 dark:hover:bg-gray-600 shadow-sm flex-1 sm:flex-none">Today</button>
                ${state.adminToken ? `<button onclick="actions.logout()" class="px-4 py-2 bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 text-sm font-bold rounded-xl hover:bg-red-100 transition-colors">${Icon('log-out', 18)}</button>` : `<button onclick="actions.openAdminModal()" class="px-4 py-2 bg-gray-900 dark:bg-brand-pink text-white text-sm font-bold rounded-xl hover:opacity-90 transition-opacity shadow-lg active:scale-95">${Icon('lock', 18)}</button>`}
              </div>
            </div>
          </div>`;

        // Calendar Logic
        const calYear = state.currentDate.getFullYear();
        const calMonth = state.currentDate.getMonth();
        const daysInMonth = getDaysInMonth(calYear, calMonth);
        const startDay = getFirstDayOfMonth(calYear, calMonth);
        const todayStr = formatDateKey(new Date().getFullYear(), new Date().getMonth(), new Date().getDate());
        let gridHtml = '';
        for(let i=0; i<startDay; i++) gridHtml += `<div class="calendar-grid-cell bg-gray-50/50 dark:bg-gray-900/30 border-r border-b border-gray-100 dark:border-gray-700"></div>`;
        for(let day=1; day<=daysInMonth; day++) {
          const dateKey = formatDateKey(calYear, calMonth, day);
          const dayEvents = state.events[dateKey] || [];
          const isToday = dateKey === todayStr;
          const numClass = isToday ? 'bg-gradient-today text-white shadow-lg scale-110 z-10 transition-transform ring-2 ring-white dark:ring-gray-700' : 'text-gray-700 dark:text-gray-300';
          const eventsHtml = dayEvents.map((evt, idx) => {
            const textContent = (evt.title + ' ' + (evt.description || '')).toLowerCase();
            let displayTitle = evt.title;
            let styleClass = idx % 2 === 0 ? 'bg-brand-pink/10 text-brand-pink border border-brand-pink/20' : 'bg-brand-purple/10 text-brand-purple border border-brand-purple/20 dark:bg-brand-orange/10 dark:text-brand-orange dark:border-brand-orange/20';
            if (textContent.includes('postponed')) { displayTitle = 'Postponed'; styleClass = 'bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 border border-red-200 dark:border-red-800'; } 
            else if (textContent.includes('cancelled')) { displayTitle = 'Cancelled'; styleClass = 'bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 border border-red-200 dark:border-red-800'; } 
            else if (textContent.includes('extended')) { displayTitle = 'Extended'; styleClass ='bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-400 border border-green-200 dark:border-green-800'; }
            return `<div class="hidden sm:block text-[10px] md:text-xs truncate px-2 py-1 rounded-md font-bold shadow-sm mb-1 ${styleClass}">${displayTitle}</div>`;
          }).join('');
          gridHtml += `<div onclick="actions.selectDate('${dateKey}')" class="calendar-grid-cell relative border-r border-b border-gray-100 dark:border-gray-700 p-1 sm:p-2 cursor-pointer bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-750 transition-colors duration-200"><div class="flex justify-between items-start mb-1"><span class="flex items-center justify-center w-7 h-7 sm:w-8 sm:h-8 rounded-full text-xs sm:text-sm font-bold ${numClass}">${day}</span>${dayEvents.length > 0 ? '<span class="sm:hidden flex h-1.5 w-1.5 rounded-full bg-brand-pink mb-auto mt-1 mr-1 shadow-sm"></span>' : ''}</div><div class="overflow-hidden">${eventsHtml}</div></div>`;
        }
        const total = startDay + daysInMonth;
        const padding = total % 7 === 0 ? 0 : 7 - (total % 7);
        for(let i=0; i<padding; i++) gridHtml += `<div class="calendar-grid-cell bg-gray-50/50 dark:bg-gray-900/30 border-r border-b border-gray-100 dark:border-gray-700"></div>`;
        const calendarHtml = `<div class="lg:col-span-3"><section class="bg-white dark:bg-gray-800 rounded-3xl shadow-xl border border-white dark:border-gray-700 overflow-hidden"><div class="grid grid-cols-7 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50">${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d => `<div class="py-3 text-center text-xs sm:text-sm font-bold text-gray-500 dark:text-gray-400 uppercase tracking-widest">${d}</div>`).join('')}</div><div class="grid grid-cols-7 bg-gray-100 dark:bg-gray-900 gap-px">${gridHtml}</div></section></div>`;

        // Sidebar
        const dates = Object.keys(state.events).sort();
        const now = new Date(); now.setHours(0,0,0,0);
        const upcoming = dates.filter(d => new Date(d) >= now).slice(0, 15).map(date => {
          const evts = state.events[date];
          const dateStr = new Date(date).toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
          return `<article onclick="actions.selectDate('${date}')" class="group cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 p-2 rounded-xl transition-colors -mx-2"><div class="text-xs font-bold text-brand-purple dark:text-brand-orange mb-2 uppercase tracking-wider pl-1">${dateStr}</div>${evts.map(e => { const text = (e.title + ' ' + (e.description || '')).toLowerCase(); if (text.includes('postponed') || text.includes('cancelled')) return `<div class="mb-2 bg-red-50 dark:bg-red-900/20 p-3 rounded-xl border border-red-100 dark:border-red-800 shadow-sm flex items-center justify-center"><div class="font-bold text-red-600 dark:text-red-400 text-sm uppercase tracking-wide">${text.includes('postponed') ? 'Postponed' : 'Cancelled'}</div></div>`; else if (text.includes('extended')) return `<div class="mb-2 bg-green-50 dark:bg-green-900/20 p-3 rounded-xl border border-green-100 dark:border-green-800 shadow-sm flex items-center justify-center"><div class="font-bold text-green-600 dark:text-green-400 text-sm uppercase tracking-wide">${'Extended'}</div></div>`; return `<div class="mb-2 bg-white dark:bg-gray-700 p-3 rounded-xl border border-gray-100 dark:border-gray-600 shadow-sm"><div class="font-bold text-gray-900 dark:text-gray-100 text-sm line-clamp-2">${e.title}</div></div>`; }).join('')}</article>`;
        }).join('');
        const sidebarHtml = `<aside class="lg:col-span-1 relative"><div class="w-full h-full lg:absolute lg:inset-0"><div class="bg-white dark:bg-gray-800 rounded-3xl shadow-lg border border-white dark:border-gray-700 p-6 h-full flex flex-col"><div class="flex items-center gap-3 mb-5 border-b border-gray-100 dark:border-gray-700 pb-4 shrink-0"><div class="p-2 bg-orange-50 dark:bg-orange-900/30 text-brand-orange rounded-xl">${Icon('clock', 20)}</div><h2 class="text-lg font-extrabold text-gray-800 dark:text-gray-200 tracking-tight">Upcoming</h2></div><div class="space-y-4 overflow-y-auto pr-2 custom-scrollbar flex-1 min-h-0">${upcoming || '<p class="text-sm text-gray-400 font-medium text-center py-4">No upcoming events.</p>'}</div></div></div></aside>`;

        // Courses
        const courseCards = state.courses.map(course => `<div onclick="fetchCourseImages('${course}')" class="course-card bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-md border border-gray-100 dark:border-gray-700 flex flex-col items-center gap-3 cursor-pointer group"><div class="w-12 h-12 bg-brand-pink/5 group-hover:bg-brand-pink/10 text-brand-pink rounded-xl flex items-center justify-center transition-colors">${Icon('book-open', 24)}</div><h3 class="text-sm font-extrabold text-gray-800 dark:text-gray-200 uppercase tracking-wider line-clamp-1">${course}</h3></div>`).join('');
        const coursesHtml = `<section class="mt-12"><div class="flex items-center gap-3 mb-6"><div class="p-2 bg-brand-pink/10 text-brand-pink rounded-xl">${Icon('library', 22)}</div><h2 class="text-2xl font-extrabold text-gray-900 dark:text-white tracking-tight">Academic Resources</h2></div><div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">${courseCards || `<p class="col-span-full text-center text-gray-400 py-6 text-sm">No course folders found in repository.</p>`}</div></section>`;

        // Modals
        let modalsHtml = '';
        if (state.isReminderModalOpen) {
            modalsHtml += `<div class="fixed inset-0 z-[60] flex items-center justify-center bg-black/70 backdrop-blur-sm p-4"><div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center animate-in fade-in zoom-in-95 relative"><button onclick="actions.closeReminderModal()" class="absolute top-3 right-3 p-2 text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors">${Icon('x', 20)}</button><div class="w-16 h-16 bg-blue-50 dark:bg-blue-900/30 text-brand-purple dark:text-brand-pink rounded-full flex items-center justify-center mx-auto mb-4">${Icon('bell-ring', 32)}</div><h3 class="text-xl font-extrabold text-gray-900 dark:text-white mb-2">Set Reminders</h3><p class="text-gray-500 dark:text-gray-400 text-sm mb-6">Notify me before upcoming academic events.</p><div class="flex items-center gap-2 mb-6 justify-center"><input type="number" min="1" max="100" value="${state.reminderValue}" oninput="actions.setReminderValue(this.value)" class="w-16 px-2 py-1.5 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-center font-bold text-gray-900 dark:text-white outline-none focus:ring-2 focus:ring-brand-purple"><select onchange="actions.setReminderUnit(this.value)" class="px-2 py-1.5 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-bold text-gray-900 dark:text-white outline-none focus:ring-2 focus:ring-brand-purple"><option value="days" ${state.reminderUnit === 'days' ? 'selected' : ''}>Days</option><option value="hours" ${state.reminderUnit === 'hours' ? 'selected' : ''}>Hours</option></select></div><button onclick="actions.confirmReminder()" class="w-full py-3 bg-brand-purple dark:bg-brand-pink text-white font-bold rounded-xl shadow-lg active:scale-95 transition-all">Enable Alerts</button></div></div>`;
        }

        if (state.isAdminModalOpen) {
            modalsHtml += `<div class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4"><div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in-95"><div class="bg-gray-900 dark:bg-gray-950 p-4 flex justify-between items-center text-white font-bold"><h3 class="flex items-center gap-2 text-brand-orange">${Icon('lock', 20)} Editor Portal</h3><button onclick="actions.closeAdminModal()">${Icon('x', 20)}</button></div><div class="p-6 space-y-4"><label for="admin-token" class="sr-only">GitHub Auth Token</label><input id="admin-token" type="password" class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 dark:text-white border dark:border-gray-600 rounded-xl outline-none focus:ring-2 focus:ring-brand-purple" placeholder="Access Key"><div class="flex justify-end gap-3"><button onclick="actions.closeAdminModal()" class="text-gray-500 font-semibold">Cancel</button><button onclick="actions.login(document.getElementById('admin-token').value)" class="px-6 py-2 bg-brand-purple dark:bg-brand-pink text-white font-bold rounded-lg shadow-lg">Login</button></div></div></div></div>`;
        }

        if (state.selectedDateKey) {
            const dateStr = new Date(state.selectedDateKey).toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const dayEvents = state.events[state.selectedDateKey] || [];
            let contentHtml = '';
            if (state.isAddEventMode || state.editingEventIndex !== null) {
                contentHtml = `<div class="bg-gray-50 dark:bg-gray-900/50 p-4 rounded-xl border border-gray-200 dark:border-gray-700"><div class="space-y-3"><input id="form-title" class="w-full px-3 py-2 bg-white dark:bg-gray-800 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-brand-purple dark:text-white outline-none font-bold" value="${state.formTitle}" placeholder="Event title..." autofocus oninput="actions.updateForm('title', this.value)"><textarea id="form-desc" class="w-full px-3 py-2 bg-white dark:bg-gray-800 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-brand-purple dark:text-white outline-none resize-none" rows="3" placeholder="Details..." oninput="actions.updateForm('desc', this.value)">${state.formDesc}</textarea><div class="flex justify-end gap-2"><button onclick="actions.cancelForm()" class="px-3 py-1.5 text-sm font-semibold text-gray-500 dark:text-gray-400">Cancel</button><button onclick="actions.saveForm()" class="px-4 py-1.5 text-sm font-bold bg-brand-purple dark:bg-brand-pink text-white rounded-md shadow-md">Save</button></div></div>`;
            } else {
                contentHtml = dayEvents.length === 0 ? `<div class="text-center py-10 text-gray-400">${Icon('calendar', 48, 'mx-auto mb-3 opacity-30')}<p>No academic events scheduled for today.</p></div>` : `<div class="space-y-4">${dayEvents.map((evt, idx) => `<article class="relative bg-white dark:bg-gray-800 border-l-[6px] border-brand-purple dark:border-brand-pink p-5 rounded-r-xl shadow-sm border border-gray-100 dark:border-gray-700"><h4 class="font-extrabold text-gray-900 dark:text-white text-xl mb-2 leading-tight">${evt.title}</h4><p class="text-gray-600 dark:text-gray-300 text-sm whitespace-pre-wrap">${evt.description}</p>${state.adminToken ? `<div class="absolute top-3 right-3 flex gap-1"><button onclick="actions.startEditEvent(${idx})" class="p-1.5 text-blue-600 dark:text-blue-400">${Icon('edit-2', 16)}</button><button onclick="actions.deleteEvent(${idx})" class="p-1.5 text-red-600 dark:text-red-400">${Icon('trash-2', 16)}</button></div>` : ''}</article>`).join('')}</div>`;
            }
            const footerHtml = (state.adminToken && !state.isAddEventMode && state.editingEventIndex === null) ? `<div class="bg-white dark:bg-gray-800 p-4 border-t dark:border-gray-700 flex justify-start items-center"><button onclick="actions.startAddEvent()" class="px-5 py-2 bg-brand-purple dark:bg-brand-pink text-white rounded-xl text-sm font-bold shadow-lg flex items-center gap-2">${Icon('plus', 18)} Add Event</button></div>` : '';
            const shareBtnHtml = dayEvents.length > 0 ? `<button onclick="actions.shareEvent('${state.selectedDateKey}')" class="bg-white/20 hover:bg-white/30 px-3 py-1.5 rounded-lg flex items-center gap-2 text-xs font-bold transition-colors">${Icon('share-2', 16)} <span id="share-btn-text">Share Link</span></button>` : '';
            modalsHtml += `<div class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4"><div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[85vh] modal-anim"><div class="bg-gradient-to-r from-brand-pink to-brand-orange p-5 flex justify-between items-center text-white shrink-0"><div><h3 class="text-2xl font-extrabold">Events Schedule</h3><p class="text-sm font-medium opacity-90">${dateStr}</p></div><div class="flex items-center gap-2">${shareBtnHtml}<button onclick="actions.closeModal()" class="p-2 hover:bg-white/20 rounded-full">${Icon('x', 24)}</button></div></div><div class="p-6 overflow-y-auto flex-1 bg-gray-50 dark:bg-gray-900/50">${contentHtml}</div>${footerHtml}</div></div>`;
        }

        if (state.selectedCourse) {
             const imagesHtml = state.courseImages.map((url, index) => `<div class="bg-gray-200 dark:bg-gray-700 rounded-xl overflow-hidden shadow-sm hover:shadow-lg transition-shadow"><img src="${url}" alt="Course Material" loading="lazy" class="w-full h-full object-cover aspect-[3/4] cursor-pointer" onclick="actions.openPreview(${index})"></div>`).join('');
             modalsHtml += `<div class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-md p-4"><div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl w-full max-w-5xl overflow-hidden flex flex-col max-h-[90vh] modal-anim"><div class="p-5 flex justify-between items-center border-b dark:border-gray-700 bg-gray-50/50 dark:bg-gray-800/50"><div class="flex items-center gap-3"><div class="p-2 bg-brand-pink text-white rounded-xl shadow-md">${Icon('image', 20)}</div><h3 class="text-xl font-extrabold text-gray-900 dark:text-white uppercase tracking-tight truncate">${state.selectedCourse} Materials</h3></div><button onclick="actions.closeGallery()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full text-gray-500 transition-colors">${Icon('x', 24)}</button></div><div class="p-6 overflow-y-auto flex-1 bg-gray-50 dark:bg-gray-900/50">${state.isLoadingGallery ? `<div class="flex flex-col items-center justify-center py-20 text-brand-pink gap-4"><i data-lucide="loader-2" class="w-12 h-12 animate-spin"></i><span class="font-bold animate-pulse uppercase tracking-widest text-xs">Fetching Materials...</span></div>` : `<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">${imagesHtml || `<div class="col-span-full text-center py-20 text-gray-400 italic">No image materials found in this folder.</div>`}</div>`}</div></div></div>`;
        }

        if (state.previewImageIndex !== null) {
            const currentUrl = state.courseImages[state.previewImageIndex];
            const total = state.courseImages.length;
            const current = state.previewImageIndex + 1;
            modalsHtml += `<div class="fixed inset-0 z-[200] flex flex-col items-center justify-center bg-black/95 transition-all backdrop-blur-xl" onclick="actions.closePreview()"><div class="absolute top-0 left-0 right-0 p-4 md:p-6 flex justify-between items-center text-white z-[210]"><div class="bg-black/40 backdrop-blur-lg px-4 py-2 rounded-full text-xs md:text-sm font-bold tracking-[0.2em] uppercase border border-white/10">${state.selectedCourse} â€” ${current} of ${total}</div><button onclick="actions.closePreview(); event.stopPropagation();" class="p-3 text-white bg-white/10 hover:bg-white/20 rounded-full transition-colors active:scale-90">${Icon('x', 24)}</button></div><div class="relative w-full h-full flex items-center justify-center px-4"><button onclick="actions.prevPreviewImage(event)" class="nav-btn absolute left-4 md:left-8 z-[220] p-4 md:p-6 text-white bg-white/5 hover:bg-white/20 rounded-full backdrop-blur-sm transition-all shadow-2xl hover:scale-110 active:scale-95">${Icon('chevron-left', 32)}</button><div class="w-full h-full flex items-center justify-center" onclick="event.stopPropagation()"><img src="${currentUrl}" class="max-w-full max-h-[85vh] object-contain preview-anim shadow-[0_0_50px_rgba(0,0,0,0.5)] rounded-sm" alt="Preview"></div><button onclick="actions.nextPreviewImage(event)" class="nav-btn absolute right-4 md:right-8 z-[220] p-4 md:p-6 text-white bg-white/5 hover:bg-white/20 rounded-full backdrop-blur-sm transition-all shadow-2xl hover:scale-110 active:scale-95">${Icon('chevron-right', 32)}</button></div><div class="absolute bottom-6 left-1/2 -translate-x-1/2 text-white/40 text-[9px] font-bold uppercase tracking-[0.4em] pointer-events-none hidden md:block">Use Left / Right Arrows to navigate</div></div>`;
        }

        root.innerHTML = headerHtml + `<div class="grid grid-cols-1 lg:grid-cols-4 gap-4 lg:gap-8">${calendarHtml}${sidebarHtml}</div>${coursesHtml}${modalsHtml}`;
        lucide.createIcons();
      }
      
      // Initial fetch for calendar
      fetchEvents();

      // =========================================================================
      // ========================== 2026 ANIMATION LOGIC =========================
      // =========================================================================
      
      const NY_CONFIG = {
        particleCount: 150,
        gravity: 0.06,
        friction: 0.96,
        launchInterval: 120,
        hueVariance: 40
      };

      const nyCanvas = document.getElementById('canvas-container');
      const nyCtx = nyCanvas.getContext('2d');
      const nyOverlay = document.getElementById('ny-2026-overlay');
      const soundHint = document.getElementById('ny-sound-hint');
      
      let nyFireworks = [];
      let nyParticles = [];
      let nyCanvasWidth, nyCanvasHeight;
      let nyTimerTick = 0;
      let nyAnimationId = null;
      let nyAudioEnabled = false;
      
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      let nyAudioCtx = new AudioContext();

      function resizeNyCanvas() {
        nyCanvasWidth = window.innerWidth;
        nyCanvasHeight = window.innerHeight;
        nyCanvas.width = nyCanvasWidth;
        nyCanvas.height = nyCanvasHeight;
      }
      window.addEventListener('resize', resizeNyCanvas);
      resizeNyCanvas();

      function initNyAudio() {
        if (nyAudioEnabled) return;
        nyAudioCtx.resume().then(() => {
          nyAudioEnabled = true;
          soundHint.innerText = "Sound: ON";
          soundHint.style.color = "#00f260";
        }).catch(e => {
          soundHint.innerText = "Sound: Blocked (Click anywhere)";
          soundHint.style.color = "#ff4444";
          // Fallback
          document.body.addEventListener('click', () => {
            nyAudioCtx.resume();
            nyAudioEnabled = true;
            soundHint.innerText = "Sound: ON";
          }, { once: true });
        });
      }

      function playExplosionSound() {
        if (!nyAudioEnabled) return;
        const osc = nyAudioCtx.createOscillator();
        const gainNode = nyAudioCtx.createGain();
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(150, nyAudioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(0.01, nyAudioCtx.currentTime + 0.6);
        gainNode.gain.setValueAtTime(0.2, nyAudioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.001, nyAudioCtx.currentTime + 0.6);
        osc.connect(gainNode);
        gainNode.connect(nyAudioCtx.destination);
        osc.start();
        osc.stop(nyAudioCtx.currentTime + 0.6);
      }

      function random(min, max) { return Math.random() * (max - min) + min; }
      function calculateDistance(p1x, p1y, p2x, p2y) {
        let xDistance = p1x - p2x;
        let yDistance = p1y - p2y;
        return Math.sqrt(Math.pow(xDistance, 2) + Math.pow(yDistance, 2));
      }

      class NyFirework {
        constructor(sx, sy, tx, ty) {
          this.x = sx; this.y = sy; this.sx = sx; this.sy = sy; this.tx = tx; this.ty = ty;
          this.distanceToTarget = calculateDistance(sx, sy, tx, ty);
          this.distanceTraveled = 0;
          this.coordinates = [];
          this.coordinateCount = 3;
          while(this.coordinateCount--) this.coordinates.push([this.x, this.y]);
          this.angle = Math.atan2(ty - sy, tx - sx);
          this.speed = 2; this.acceleration = 1.05;
          this.brightness = random(50, 70);
          this.targetRadius = 1;
        }
        update(index) {
          this.coordinates.pop();
          this.coordinates.unshift([this.x, this.y]);
          if(this.targetRadius < 8) this.targetRadius += 0.3; else this.targetRadius = 1;
          this.speed *= this.acceleration;
          let vx = Math.cos(this.angle) * this.speed;
          let vy = Math.sin(this.angle) * this.speed;
          this.distanceTraveled = calculateDistance(this.sx, this.sy, this.x + vx, this.y + vy);
          if(this.distanceTraveled >= this.distanceToTarget) {
            createNyParticles(this.tx, this.ty);
            nyFireworks.splice(index, 1);
            playExplosionSound();
          } else {
            this.x += vx; this.y += vy;
          }
        }
        draw() {
          nyCtx.beginPath();
          nyCtx.moveTo(this.coordinates[this.coordinates.length-1][0], this.coordinates[this.coordinates.length-1][1]);
          nyCtx.lineTo(this.x, this.y);
          nyCtx.strokeStyle = 'hsl(' + random(0, 360) + ', 100%, ' + this.brightness + '%)';
          nyCtx.lineWidth = 2; nyCtx.stroke();
          nyCtx.beginPath();
          nyCtx.arc(this.tx, this.ty, this.targetRadius, 0, Math.PI * 2); nyCtx.stroke();
        }
      }

      class NyParticle {
        constructor(x, y) {
          this.x = x; this.y = y;
          this.coordinates = []; this.coordinateCount = 5;
          while(this.coordinateCount--) this.coordinates.push([this.x, this.y]);
          this.angle = random(0, Math.PI * 2);
          this.speed = random(4, 16);
          this.friction = NY_CONFIG.friction;
          this.gravity = NY_CONFIG.gravity;
          this.hue = random(0, 360);
          this.brightness = random(50, 80);
          this.alpha = 1;
          this.decay = random(0.01, 0.02);
        }
        update(index) {
          this.coordinates.pop();
          this.coordinates.unshift([this.x, this.y]);
          this.speed *= this.friction;
          this.x += Math.cos(this.angle) * this.speed;
          this.y += Math.sin(this.angle) * this.speed + this.gravity;
          this.alpha -= this.decay;
          if(this.alpha <= this.decay) nyParticles.splice(index, 1);
        }
        draw() {
          nyCtx.beginPath();
          nyCtx.moveTo(this.coordinates[this.coordinates.length-1][0], this.coordinates[this.coordinates.length-1][1]);
          nyCtx.lineTo(this.x, this.y);
          nyCtx.strokeStyle = 'hsla(' + this.hue + ', 100%, ' + this.brightness + '%, ' + this.alpha + ')';
          nyCtx.lineWidth = 2; nyCtx.stroke();
        }
      }

      function createNyParticles(x, y) {
        let count = NY_CONFIG.particleCount;
        while(count--) nyParticles.push(new NyParticle(x, y));
      }

      function updateNyCountdown() {
        const targetDate = new Date("January 1, 2026 00:00:00").getTime();
        const now = new Date().getTime();
        const diff = targetDate - now;
        if (diff < 0) {
            document.getElementById('countdown').innerHTML = "<div style='font-size: 2rem; color: var(--accent-gold)'>Happy New Year!</div>";
            return;
        }
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
        document.getElementById('ny-days').innerText = String(days).padStart(2,'0');
        document.getElementById('ny-hours').innerText = String(hours).padStart(2,'0');
        document.getElementById('ny-minutes').innerText = String(minutes).padStart(2,'0');
        document.getElementById('ny-seconds').innerText = String(seconds).padStart(2,'0');
      }

      function nyAnimationLoop() {
        if (!nyOverlay || nyOverlay.style.display === 'none') return;
        nyAnimationId = requestAnimationFrame(nyAnimationLoop);
        nyCtx.globalCompositeOperation = 'destination-out';
        nyCtx.fillStyle = 'rgba(0, 0, 0, 0.2)'; 
        nyCtx.fillRect(0, 0, nyCanvasWidth, nyCanvasHeight);
        nyCtx.globalCompositeOperation = 'lighter';
        
        let i = nyFireworks.length;
        while(i--) { nyFireworks[i].draw(); nyFireworks[i].update(i); }
        
        let j = nyParticles.length;
        while(j--) { nyParticles[j].draw(); nyParticles[j].update(j); }
        
        if (nyTimerTick >= NY_CONFIG.launchInterval) {
          let startX = random(nyCanvasWidth * 0.1, nyCanvasWidth * 0.9);
          let targetX = random(0, nyCanvasWidth);
          let targetY = random(0, nyCanvasHeight * 0.6);
          nyFireworks.push(new NyFirework(startX, nyCanvasHeight, targetX, targetY));
          nyTimerTick = 0;
        } else {
          nyTimerTick++;
        }
      }

      // Initialize NY Overlay
      window.addEventListener('load', () => {
        initNyAudio();
        nyAnimationLoop();
        setInterval(updateNyCountdown, 1000);
        updateNyCountdown();
      });

      // Close Overlay Function
      function close2026Overlay() {
        nyOverlay.style.transition = "opacity 0.5s ease";
        nyOverlay.style.opacity = "0";
        setTimeout(() => {
          nyOverlay.style.display = "none";
          cancelAnimationFrame(nyAnimationId); // Stop loop to save CPU
          document.getElementById('root').style.opacity = "1"; // Reveal main app
        }, 500);
      }

    </script>
  </body>
</html>
